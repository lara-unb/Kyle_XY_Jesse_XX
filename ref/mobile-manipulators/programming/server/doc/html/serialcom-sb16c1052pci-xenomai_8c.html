<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>mmrobot-server: serialcom-sb16c1052pci-xenomai.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>serialcom-sb16c1052pci-xenomai.c File Reference</h1><code>#include &lt;stdio.h&gt;</code><br/>
<code>#include &lt;math.h&gt;</code><br/>
<code>#include &lt;signal.h&gt;</code><br/>
<code>#include &lt;sys/io.h&gt;</code><br/>
<code>#include &lt;unistd.h&gt;</code><br/>
<code>#include &lt;sys/mman.h&gt;</code><br/>
<code>#include &lt;native/task.h&gt;</code><br/>
<code>#include &lt;native/timer.h&gt;</code><br/>
<code>#include &lt;native/sem.h&gt;</code><br/>
<code>#include &lt;linux/pci.h&gt;</code><br/>
<code>#include &lt;linux/pci_regs.h&gt;</code><br/>
<code>#include &lt;linux/virtio_pci.h&gt;</code><br/>
<code>#include &lt;pci/pci.h&gt;</code><br/>
<code>#include &lt;pci/config.h&gt;</code><br/>
<code>#include &lt;pci/header.h&gt;</code><br/>
<code>#include &lt;pci/types.h&gt;</code><br/>
<code>#include &quot;<a class="el" href="serialcom_8h_source.html">serialcom.h</a>&quot;</code><br/>

<p><a href="serialcom-sb16c1052pci-xenomai_8c_source.html">Go to the source code of this file.</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="serialcom-sb16c1052pci-xenomai_8c.html#a51f9c3fd33083b796c8db0b91d25dfd2">PCI_DEVICE_ID_MP1</a>&nbsp;&nbsp;&nbsp;0x4d01</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="serialcom-sb16c1052pci-xenomai_8c.html#a36109a3edeafb33def0bb6e2f118f94c">PCI_DEVICE_ID_MP2</a>&nbsp;&nbsp;&nbsp;0x4d02</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="serialcom-sb16c1052pci-xenomai_8c.html#a583579ba38499640c937c74b3b78a759">PCI_VENDOR_ID_MULTIPORT</a>&nbsp;&nbsp;&nbsp;0x14A1</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="serialcom-sb16c1052pci-xenomai_8c.html#ab8562a5ce361317b4d7453a8354a5685">serialcom_delayus</a>(a)&nbsp;&nbsp;&nbsp;rt_task_sleep((RTIME)((a)*1000))</td></tr>
<tr><td colspan="2"><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="serialcom-sb16c1052pci-xenomai_8c.html#a480f412a5b77f8ad7966a267b4c26f89">serialcom_close</a> (<a class="el" href="structSERIALPORTCONFIG.html">PSERIALPORTCONFIG</a> pSerialPortConfig)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="serialcom-sb16c1052pci-xenomai_8c.html#a5eb7bbd8dec689b7e1943f71a54ed89b">serialcom_init</a> (<a class="el" href="structSERIALPORTCONFIG.html">PSERIALPORTCONFIG</a> pSerialPortConfig, int ComPortNumber, unsigned long int ComPortBPS)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="serialcom-sb16c1052pci-xenomai_8c.html#ad43e67f6cf73e5f0ca1a1490f4e68d6f">serialcom_pci_close_device</a> (struct pci_access *pacc)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="serialcom-sb16c1052pci-xenomai_8c.html#ac47f39cfcf8738d1da7022b1f466fcab">serialcom_pci_find_device</a> (unsigned int vendor_id, unsigned int device_id, unsigned long *pbase_address, struct pci_access **ppacc)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="serialcom-sb16c1052pci-xenomai_8c.html#aaae4ccb4f6a36146c4191a76f15c875c">serialcom_receivebyte</a> (<a class="el" href="structSERIALPORTCONFIG.html">PSERIALPORTCONFIG</a> pSerialPortConfig, unsigned char *pData, double MaximaEsperaUS)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="serialcom-sb16c1052pci-xenomai_8c.html#aca6e0ddb69ed96c35f139ff05d5b3a72">serialcom_semsignal</a> (<a class="el" href="structSERIALPORTCONFIG.html">PSERIALPORTCONFIG</a> pSerialPortConfig)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="serialcom-sb16c1052pci-xenomai_8c.html#ac1deb0bc4fce44117f1d2b3aa0d78a2a">serialcom_semwait</a> (<a class="el" href="structSERIALPORTCONFIG.html">PSERIALPORTCONFIG</a> pSerialPortConfig)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="serialcom-sb16c1052pci-xenomai_8c.html#ac5dcc32914d203e1a81c377fef948014">serialcom_sendbyte</a> (<a class="el" href="structSERIALPORTCONFIG.html">PSERIALPORTCONFIG</a> pSerialPortConfig, unsigned char *pData)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="serialcom-sb16c1052pci-xenomai_8c.html#a7ad801f3b47f1ee0e0cf90ab78a20983">serialcom_status</a> (<a class="el" href="structSERIALPORTCONFIG.html">PSERIALPORTCONFIG</a> pSerialPortConfig)</td></tr>
<tr><td colspan="2"><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">RT_SEM&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="serialcom-sb16c1052pci-xenomai_8c.html#a74ad210af22afadd34ea631fd41bd860">pComPortSemaphores</a> [4]</td></tr>
</table>
<hr/><h2>Define Documentation</h2>
<a class="anchor" id="a51f9c3fd33083b796c8db0b91d25dfd2"></a><!-- doxytag: member="serialcom&#45;sb16c1052pci&#45;xenomai.c::PCI_DEVICE_ID_MP1" ref="a51f9c3fd33083b796c8db0b91d25dfd2" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define PCI_DEVICE_ID_MP1&nbsp;&nbsp;&nbsp;0x4d01</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="serialcom-sb16c1052pci-xenomai_8c_source.html#l00039">39</a> of file <a class="el" href="serialcom-sb16c1052pci-xenomai_8c_source.html">serialcom-sb16c1052pci-xenomai.c</a>.</p>

</div>
</div>
<a class="anchor" id="a36109a3edeafb33def0bb6e2f118f94c"></a><!-- doxytag: member="serialcom&#45;sb16c1052pci&#45;xenomai.c::PCI_DEVICE_ID_MP2" ref="a36109a3edeafb33def0bb6e2f118f94c" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define PCI_DEVICE_ID_MP2&nbsp;&nbsp;&nbsp;0x4d02</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="serialcom-sb16c1052pci-xenomai_8c_source.html#l00040">40</a> of file <a class="el" href="serialcom-sb16c1052pci-xenomai_8c_source.html">serialcom-sb16c1052pci-xenomai.c</a>.</p>

</div>
</div>
<a class="anchor" id="a583579ba38499640c937c74b3b78a759"></a><!-- doxytag: member="serialcom&#45;sb16c1052pci&#45;xenomai.c::PCI_VENDOR_ID_MULTIPORT" ref="a583579ba38499640c937c74b3b78a759" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define PCI_VENDOR_ID_MULTIPORT&nbsp;&nbsp;&nbsp;0x14A1</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="serialcom-sb16c1052pci-xenomai_8c_source.html#l00038">38</a> of file <a class="el" href="serialcom-sb16c1052pci-xenomai_8c_source.html">serialcom-sb16c1052pci-xenomai.c</a>.</p>

</div>
</div>
<a class="anchor" id="ab8562a5ce361317b4d7453a8354a5685"></a><!-- doxytag: member="serialcom&#45;sb16c1052pci&#45;xenomai.c::serialcom_delayus" ref="ab8562a5ce361317b4d7453a8354a5685" args="(a)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define serialcom_delayus</td>
          <td>(</td>
          <td class="paramtype">a&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td>&nbsp;&nbsp;&nbsp;rt_task_sleep((RTIME)((a)*1000))</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="serialcom-sb16c1052pci-xenomai_8c_source.html#l00050">50</a> of file <a class="el" href="serialcom-sb16c1052pci-xenomai_8c_source.html">serialcom-sb16c1052pci-xenomai.c</a>.</p>

</div>
</div>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="a480f412a5b77f8ad7966a267b4c26f89"></a><!-- doxytag: member="serialcom&#45;sb16c1052pci&#45;xenomai.c::serialcom_close" ref="a480f412a5b77f8ad7966a267b4c26f89" args="(PSERIALPORTCONFIG pSerialPortConfig)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int serialcom_close </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structSERIALPORTCONFIG.html">PSERIALPORTCONFIG</a>&nbsp;</td>
          <td class="paramname"> <em>pSerialPortConfig</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="serialcom-sb16c1052pci-xenomai_8c_source.html#l00147">147</a> of file <a class="el" href="serialcom-sb16c1052pci-xenomai_8c_source.html">serialcom-sb16c1052pci-xenomai.c</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00148"></a>00148 {
<a name="l00149"></a>00149         rt_sem_delete(&amp;<a class="code" href="serialcom-sb16c1052pci-xenomai_8c.html#a74ad210af22afadd34ea631fd41bd860">pComPortSemaphores</a>[pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#afdab9b8ca1ed50f3970ac4d7215366e1">ComPortNumber</a>-1]);
<a name="l00150"></a>00150 
<a name="l00151"></a>00151         <span class="keywordflow">return</span> <a class="code" href="serialcom_8h.html#a5a0fdec1e76957e187bd57ebb437fb99">SERIALCOM_SUCCESS</a>;
<a name="l00152"></a>00152 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a5eb7bbd8dec689b7e1943f71a54ed89b"></a><!-- doxytag: member="serialcom&#45;sb16c1052pci&#45;xenomai.c::serialcom_init" ref="a5eb7bbd8dec689b7e1943f71a54ed89b" args="(PSERIALPORTCONFIG pSerialPortConfig, int ComPortNumber, unsigned long int ComPortBPS)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int serialcom_init </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structSERIALPORTCONFIG.html">PSERIALPORTCONFIG</a>&nbsp;</td>
          <td class="paramname"> <em>pSerialPortConfig</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>ComPortNumber</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned long int&nbsp;</td>
          <td class="paramname"> <em>ComPortBPS</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Funcao que inicia a porta serial ComPortNumber com a taxa dada em BPS por ComPortBPS. Essa funcao dever ser chamada por cada thread que tenha acesso porta serial ComPortNumber. Seus argumentos de chamada so: </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>pSerialPortConfig</em>&nbsp;</td><td>Ponteiro para estrutura SERIALPORCONFIG que guarda informaes de configurao da porta serial no contexto do thread de chamada. Mesmo que uma dada porta serial seja utilizada por diversos threads, cada thread dever ter a sua estrutura SERIALPORCONFIG. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>ComPortNumber</em>&nbsp;</td><td>Numero da porta serial, no intervalo de 1 a 4. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>ComPortBPS</em>&nbsp;</td><td>Taxa de comunicao em BPS, no intervalo de 2 a 115200. </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>SERIALCOM_SUCCESS : Porta iniciada com sucesso. </dd>
<dd>
SERIALCOM_ERROR_INCORRECTPORTNUMBER : Erro, corresponde a um ComPortNumber invlido. </dd>
<dd>
SERIALCOM_ERROR_MAXBPSPRECISION : Erro, a taxa ComPortBPS no pode ser realizada com erro inferior a. SERIALCOM_MAXBPSPRECISION. </dd>
<dd>
SERIALCOM_ERROR_IOPL : Erro, corresponde a uma tentativa de executar o programa sem que se tenha acesso privilegiado de administrador a portas de E/S. </dd></dl>

<p>Definition at line <a class="el" href="serialcom-sb16c1052pci-xenomai_8c_source.html#l00066">66</a> of file <a class="el" href="serialcom-sb16c1052pci-xenomai_8c_source.html">serialcom-sb16c1052pci-xenomai.c</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00067"></a>00067 {
<a name="l00068"></a>00068         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> BPSClockDivisor;
<a name="l00069"></a>00069         <span class="keywordtype">float</span> BPSPrecision;
<a name="l00070"></a>00070         <span class="keywordtype">char</span> semname[50];
<a name="l00071"></a>00071 
<a name="l00072"></a>00072         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> board_base_address;
<a name="l00073"></a>00073         <span class="keyword">struct </span>pci_access *pacc;
<a name="l00074"></a>00074 
<a name="l00075"></a>00075         <span class="keywordflow">if</span>((ComPortNumber&lt;0) || (ComPortNumber&gt;2)){
<a name="l00076"></a>00076                 <span class="keywordflow">return</span> <a class="code" href="serialcom_8h.html#a72c589a0e28e387b55e20336f2e93021">SERIALCOM_ERROR_INCORRECTPORTNUMBER</a>;
<a name="l00077"></a>00077         }
<a name="l00078"></a>00078         
<a name="l00079"></a>00079         printf(<span class="stringliteral">&quot;\n*** probing PCI devices:&quot;</span>);
<a name="l00080"></a>00080         <span class="keywordflow">if</span>(!<a class="code" href="serialcom-sb16c1052pci-xenomai_8c.html#ac47f39cfcf8738d1da7022b1f466fcab">serialcom_pci_find_device</a>(<a class="code" href="serialcom-sb16c1052pci-xenomai_8c.html#a583579ba38499640c937c74b3b78a759">PCI_VENDOR_ID_MULTIPORT</a>, <a class="code" href="serialcom-sb16c1052pci-xenomai_8c.html#a36109a3edeafb33def0bb6e2f118f94c">PCI_DEVICE_ID_MP2</a>, &amp;board_base_address, &amp;pacc)){
<a name="l00081"></a>00081                 printf(<span class="stringliteral">&quot;\n    device not found !&quot;</span>);
<a name="l00082"></a>00082                 <span class="keywordflow">return</span> <a class="code" href="serialcom_8h.html#a0efc6c408872166b02c815ca31b9f89e">SERIALCOM_ERROR_DEVICENOTFOUND</a>;
<a name="l00083"></a>00083         }
<a name="l00084"></a>00084         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> board_port1_base_address;
<a name="l00085"></a>00085         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> board_port2_base_address;
<a name="l00086"></a>00086         board_port1_base_address = board_base_address;
<a name="l00087"></a>00087         board_port2_base_address = board_base_address+8;
<a name="l00088"></a>00088         printf(<span class="stringliteral">&quot;\n*** board_port1_base_address: %Xh&quot;</span>,(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)board_port1_base_address);
<a name="l00089"></a>00089         printf(<span class="stringliteral">&quot;\n*** board_port2_base_address: %Xh&quot;</span>,(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)board_port2_base_address);
<a name="l00090"></a>00090         
<a name="l00091"></a>00091         <a class="code" href="serialcom-sb16c1052pci-xenomai_8c.html#ad43e67f6cf73e5f0ca1a1490f4e68d6f">serialcom_pci_close_device</a>(pacc);
<a name="l00092"></a>00092 
<a name="l00093"></a>00093         pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#afdab9b8ca1ed50f3970ac4d7215366e1">ComPortNumber</a> = ComPortNumber; 
<a name="l00094"></a>00094         pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#a60c95986733fae1a71ab89bd97ebfed4">ComPortAddress</a> = board_base_address+8*(ComPortNumber-1); 
<a name="l00095"></a>00095         
<a name="l00096"></a>00096 
<a name="l00097"></a>00097         pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#aa6dea3f4c4292d4be56bbf2d7ac4c196">ComPortBPS</a> = ComPortBPS;
<a name="l00098"></a>00098         pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#ae5c4edc520a9a85a82daada36fb4ea40">FramePeriodUS</a> = (1e7)/(((<span class="keywordtype">float</span>)(ComPortBPS)));
<a name="l00099"></a>00099 
<a name="l00100"></a>00100         BPSClockDivisor = 921600 / ComPortBPS;
<a name="l00101"></a>00101         BPSPrecision = (((double)(ComPortBPS)) - 921600.0/BPSClockDivisor)/((double)(ComPortBPS));
<a name="l00102"></a>00102         <span class="keywordflow">if</span>(fabs(BPSPrecision) &gt; <a class="code" href="serialcom_8h.html#a0eeee6b0469b12865344fb8e1dc7ff54">SERIALCOM_MAXBPSPRECISION</a>){
<a name="l00103"></a>00103                 <span class="keywordflow">return</span> <a class="code" href="serialcom_8h.html#a302cedb96f53be4d397c4307326a4cfa">SERIALCOM_ERROR_MAXBPSPRECISION</a>;
<a name="l00104"></a>00104         }
<a name="l00105"></a>00105 
<a name="l00106"></a>00106     <span class="keywordflow">if</span>(iopl(3)&lt;0){
<a name="l00107"></a>00107                 printf(<span class="stringliteral">&quot;seriallib_iniciar: iopl error&quot;</span>);
<a name="l00108"></a>00108                 <span class="keywordflow">return</span> <a class="code" href="serialcom_8h.html#a264fd1a738f038a013c61212b7ec11d3">SERIALCOM_ERROR_IOPL</a>;
<a name="l00109"></a>00109         }
<a name="l00110"></a>00110 
<a name="l00111"></a>00111         outb(0, pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#a60c95986733fae1a71ab89bd97ebfed4">ComPortAddress</a> + 1);         <span class="comment">// Desativar interrupes </span>
<a name="l00112"></a>00112         outb(0x80, pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#a60c95986733fae1a71ab89bd97ebfed4">ComPortAddress</a> + 3);      <span class="comment">// DLAB ON </span>
<a name="l00113"></a>00113         outb((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>)(BPSClockDivisor &amp; 0xFF), pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#a60c95986733fae1a71ab89bd97ebfed4">ComPortAddress</a> + 0);   <span class="comment">// Baud Rate - DL Byte </span>
<a name="l00114"></a>00114         outb((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>)((BPSClockDivisor &gt;&gt; 8) &amp; 0xFF), pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#a60c95986733fae1a71ab89bd97ebfed4">ComPortAddress</a> + 1);    <span class="comment">// Baud Rate - DH Byte </span>
<a name="l00115"></a>00115         outb(0x03, pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#a60c95986733fae1a71ab89bd97ebfed4">ComPortAddress</a> + 3);      <span class="comment">// LCR: 8 Bits, No Parity, 1 Stop Bit </span>
<a name="l00116"></a>00116         outb(0xC7, pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#a60c95986733fae1a71ab89bd97ebfed4">ComPortAddress</a> + 2);      <span class="comment">// FIFO Control: 64 bytes TX e RX FIFO, limpa TX e RX fifos</span>
<a name="l00117"></a>00117         outb(0x0B, pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#a60c95986733fae1a71ab89bd97ebfed4">ComPortAddress</a> + 4);      <span class="comment">// MCR: Ativa DTR, RTS = 0, e OUT2      </span>
<a name="l00118"></a>00118 
<a name="l00119"></a>00119         <span class="keywordtype">char</span> tmp_lcr;
<a name="l00120"></a>00120         
<a name="l00121"></a>00121         tmp_lcr = inb(pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#a60c95986733fae1a71ab89bd97ebfed4">ComPortAddress</a> + 3);            <span class="comment">// get LCR initial value</span>
<a name="l00122"></a>00122         outb(tmp_lcr | 0xBF, pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#a60c95986733fae1a71ab89bd97ebfed4">ComPortAddress</a> + 3); <span class="comment">// LCR set 0xBF</span>
<a name="l00123"></a>00123 
<a name="l00124"></a>00124         outb(0xA4, pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#a60c95986733fae1a71ab89bd97ebfed4">ComPortAddress</a> + 0);                       <span class="comment">// select page 3</span>
<a name="l00125"></a>00125         <span class="comment">// set ATR: </span>
<a name="l00126"></a>00126         <span class="comment">//              * habilita controle automatico do driver TX, deixando a linha desativada quando não transmite.</span>
<a name="l00127"></a>00127         <span class="comment">//              * habilita controle automatico do driver RX, deixando a linha desativada quando não transmite.</span>
<a name="l00128"></a>00128 <span class="comment">//      outb(0x03 | (1&lt;&lt;5) | (1&lt;&lt;4), pSerialPortConfig-&gt;ComPortAddress + 1);  </span>
<a name="l00129"></a>00129         outb(0x03 | (1&lt;&lt;5) | (1&lt;&lt;4) | (1&lt;&lt;6), pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#a60c95986733fae1a71ab89bd97ebfed4">ComPortAddress</a> + 1);  
<a name="l00130"></a>00130 <span class="comment">//      outb(0x03 | (1&lt;&lt;5) | (1&lt;&lt;4) | (1&lt;&lt;7) | (1&lt;&lt;6), pSerialPortConfig-&gt;ComPortAddress + 1);</span>
<a name="l00131"></a>00131   
<a name="l00132"></a>00132         outb(0xA5, pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#a60c95986733fae1a71ab89bd97ebfed4">ComPortAddress</a> + 0);                       <span class="comment">// select page 4</span>
<a name="l00133"></a>00133         <span class="comment">// set AFR: </span>
<a name="l00134"></a>00134         <span class="comment">//              * habilita FIFO de 256 bytes.</span>
<a name="l00135"></a>00135         outb(0x01, pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#a60c95986733fae1a71ab89bd97ebfed4">ComPortAddress</a> + 1);  
<a name="l00136"></a>00136 
<a name="l00137"></a>00137         outb(tmp_lcr, pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#a60c95986733fae1a71ab89bd97ebfed4">ComPortAddress</a> + 3);            <span class="comment">// LCR set to initial value</span>
<a name="l00138"></a>00138 
<a name="l00139"></a>00139         sprintf(semname,<span class="stringliteral">&quot;CoSem%i&quot;</span>,ComPortNumber);
<a name="l00140"></a>00140         <span class="comment">//printf(&quot;\n semname = %s&quot;,semname);</span>
<a name="l00141"></a>00141         rt_sem_create(&amp;<a class="code" href="serialcom-sb16c1052pci-xenomai_8c.html#a74ad210af22afadd34ea631fd41bd860">pComPortSemaphores</a>[ComPortNumber-1],semname,1,S_FIFO);
<a name="l00142"></a>00142         <span class="keywordflow">return</span> <a class="code" href="serialcom_8h.html#a5a0fdec1e76957e187bd57ebb437fb99">SERIALCOM_SUCCESS</a>;
<a name="l00143"></a>00143 
<a name="l00144"></a>00144         <span class="keywordflow">return</span> <a class="code" href="serialcom_8h.html#a5a0fdec1e76957e187bd57ebb437fb99">SERIALCOM_SUCCESS</a>;
<a name="l00145"></a>00145 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ad43e67f6cf73e5f0ca1a1490f4e68d6f"></a><!-- doxytag: member="serialcom&#45;sb16c1052pci&#45;xenomai.c::serialcom_pci_close_device" ref="ad43e67f6cf73e5f0ca1a1490f4e68d6f" args="(struct pci_access *pacc)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void serialcom_pci_close_device </td>
          <td>(</td>
          <td class="paramtype">struct pci_access *&nbsp;</td>
          <td class="paramname"> <em>pacc</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="serialcom-sb16c1052pci-xenomai_8c_source.html#l00366">366</a> of file <a class="el" href="serialcom-sb16c1052pci-xenomai_8c_source.html">serialcom-sb16c1052pci-xenomai.c</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00367"></a>00367 {
<a name="l00368"></a>00368         <span class="comment">/* Close everything */</span>
<a name="l00369"></a>00369         pci_cleanup(pacc);              
<a name="l00370"></a>00370 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ac47f39cfcf8738d1da7022b1f466fcab"></a><!-- doxytag: member="serialcom&#45;sb16c1052pci&#45;xenomai.c::serialcom_pci_find_device" ref="ac47f39cfcf8738d1da7022b1f466fcab" args="(unsigned int vendor_id, unsigned int device_id, unsigned long *pbase_address, struct pci_access **ppacc)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int serialcom_pci_find_device </td>
          <td>(</td>
          <td class="paramtype">unsigned int&nbsp;</td>
          <td class="paramname"> <em>vendor_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned int&nbsp;</td>
          <td class="paramname"> <em>device_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned long *&nbsp;</td>
          <td class="paramname"> <em>pbase_address</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct pci_access **&nbsp;</td>
          <td class="paramname"> <em>ppacc</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="serialcom-sb16c1052pci-xenomai_8c_source.html#l00326">326</a> of file <a class="el" href="serialcom-sb16c1052pci-xenomai_8c_source.html">serialcom-sb16c1052pci-xenomai.c</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00327"></a>00327 {
<a name="l00328"></a>00328         <span class="keyword">struct </span>pci_dev *dev;
<a name="l00329"></a>00329         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> c;
<a name="l00330"></a>00330         <span class="keywordtype">char</span> namebuf[1024], *name;
<a name="l00331"></a>00331 
<a name="l00332"></a>00332         <span class="comment">/* Get the pci_access structure */</span>
<a name="l00333"></a>00333         *ppacc = pci_alloc();
<a name="l00334"></a>00334         <span class="comment">/* Set all options you want -- here we stick with the defaults */</span>
<a name="l00335"></a>00335         <span class="comment">/* Initialize the PCI library */</span>
<a name="l00336"></a>00336         pci_init(*ppacc);               
<a name="l00337"></a>00337         <span class="comment">/* We want to get the list of devices */</span>
<a name="l00338"></a>00338         pci_scan_bus(*ppacc);           
<a name="l00339"></a>00339         <span class="comment">/* Iterate over all devices */</span>
<a name="l00340"></a>00340         <span class="keywordflow">for</span>(dev=(*ppacc)-&gt;devices; dev; dev=dev-&gt;next){
<a name="l00341"></a>00341                 <span class="comment">/* Fill in header info we need */</span>
<a name="l00342"></a>00342                 pci_fill_info(dev, PCI_FILL_IDENT | PCI_FILL_BASES | PCI_FILL_CLASS | PCI_FILL_IRQ);    
<a name="l00343"></a>00343                 <span class="comment">/* Read config register directly */</span>
<a name="l00344"></a>00344                 c = pci_read_byte(dev, PCI_INTERRUPT_PIN);                              
<a name="l00345"></a>00345                 printf(<span class="stringliteral">&quot;\n    %04x:%02x:%02x.%d vendor=%04x device=%04x class=%04x irq=%d (pin %d) base0=%lx&quot;</span>,
<a name="l00346"></a>00346                         dev-&gt;domain, dev-&gt;bus, dev-&gt;dev, dev-&gt;func, dev-&gt;vendor_id, dev-&gt;device_id,
<a name="l00347"></a>00347                         dev-&gt;device_class, dev-&gt;irq, c, (<span class="keywordtype">long</span>) dev-&gt;base_addr[0]);
<a name="l00348"></a>00348                 <span class="comment">/* Look up and print the full name of the device */</span>
<a name="l00349"></a>00349                 name = pci_lookup_name(*ppacc, namebuf, <span class="keyword">sizeof</span>(namebuf), PCI_LOOKUP_DEVICE, dev-&gt;vendor_id, dev-&gt;device_id);
<a name="l00350"></a>00350                 printf(<span class="stringliteral">&quot; (%s)&quot;</span>, name);
<a name="l00351"></a>00351                 <span class="comment">/* Connect */</span>
<a name="l00352"></a>00352                 <span class="keywordflow">if</span>((dev-&gt;vendor_id==vendor_id)&amp;&amp;(dev-&gt;device_id==device_id)){
<a name="l00353"></a>00353                         <span class="comment">// recover base address</span>
<a name="l00354"></a>00354                         *pbase_address = pci_read_long(dev, PCI_BASE_ADDRESS_0);
<a name="l00355"></a>00355                         *pbase_address &amp;= PCI_BASE_ADDRESS_IO_MASK;
<a name="l00356"></a>00356 
<a name="l00357"></a>00357                         <span class="keywordflow">return</span> 1;
<a name="l00358"></a>00358                 }
<a name="l00359"></a>00359         }
<a name="l00360"></a>00360         <span class="comment">/* Close everything */</span>
<a name="l00361"></a>00361         pci_cleanup(*ppacc);            
<a name="l00362"></a>00362         
<a name="l00363"></a>00363         <span class="keywordflow">return</span> 0;
<a name="l00364"></a>00364 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="aaae4ccb4f6a36146c4191a76f15c875c"></a><!-- doxytag: member="serialcom&#45;sb16c1052pci&#45;xenomai.c::serialcom_receivebyte" ref="aaae4ccb4f6a36146c4191a76f15c875c" args="(PSERIALPORTCONFIG pSerialPortConfig, unsigned char *pData, double MaximaEsperaUS)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">serialcom_receivebyte </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structSERIALPORTCONFIG.html">PSERIALPORTCONFIG</a>&nbsp;</td>
          <td class="paramname"> <em>pSerialPortConfig</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned char *&nbsp;</td>
          <td class="paramname"> <em>pData</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>MaximaEsperaUS</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Funcao que aguarda um byte chegar pela porta serial descrita por pSerialPortConfig por um tempo mximo dado por MaximaEsperaUS, dado em microsegundos. Se um dado chegar dentro do perodo dado por MaximaEsperaUS, o mesmo ser colocado na varivel apontada por pData. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>pSerialPortConfig</em>&nbsp;</td><td>Ponteiro para estrutura <a class="el" href="structSERIALPORTCONFIG.html">SERIALPORTCONFIG</a> que guarda informaes de configurao da porta serial no contexto do thread de chamada. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>pData</em>&nbsp;</td><td>Ponteiro para o byte recebido. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>MaximaEsperaUS</em>&nbsp;</td><td>Tempo mximo de espera pela chegada de um byte pela porta. Se MaximaEsperaUS </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>SERIALCOM_SUCCESS : Operao realizada com sucesso. Um byte foi recebido pela porta serial e se encontra disponvel na varivel apontada por pData. </dd>
<dd>
SERIALCOM_ERROR_MAXWAITFORRECEPTION : Nenhum bayte chegou dentro do tempo estipulado por MaximaEsperaUS </dd></dl>
<dl class="warning"><dt><b>Warning:</b></dt><dd>Essa funcao fica bloqueada por at MaximaEsperaUS enquanto um byte no chegar. </dd></dl>

<p>Definition at line <a class="el" href="serialcom-sb16c1052pci-xenomai_8c_source.html#l00246">246</a> of file <a class="el" href="serialcom-sb16c1052pci-xenomai_8c_source.html">serialcom-sb16c1052pci-xenomai.c</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00247"></a>00247 {
<a name="l00248"></a>00248         <span class="keywordtype">double</span>  ElapsedTime;
<a name="l00249"></a>00249         <span class="keywordtype">int</span> status;
<a name="l00250"></a>00250 
<a name="l00251"></a>00251         <span class="keywordflow">if</span>(MaximaEsperaUS&lt;0) MaximaEsperaUS = 0; <span class="comment">// Espera minima de 0 us.</span>
<a name="l00252"></a>00252 
<a name="l00253"></a>00253         ElapsedTime = 0.0;
<a name="l00254"></a>00254         <span class="keywordflow">while</span>(1)
<a name="l00255"></a>00255         {
<a name="l00256"></a>00256                 status = <a class="code" href="serialcom-sb16c1052pci-xenomai_8c.html#a7ad801f3b47f1ee0e0cf90ab78a20983">serialcom_status</a>(pSerialPortConfig);
<a name="l00257"></a>00257                 <span class="keywordflow">if</span>( (status &amp; <a class="code" href="serialcom_8h.html#a76de90ac046bfb9000ccd6845f71f25d">SERIALCOM_STATUSMASK_RX_DATA_READY</a>) ){
<a name="l00258"></a>00258 <span class="comment">//                      printf(&quot;\n FILE = %s, LINE = %i&quot;,__FILE__,__LINE__);</span>
<a name="l00259"></a>00259                         *pData = inb(pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#a60c95986733fae1a71ab89bd97ebfed4">ComPortAddress</a> + 0);
<a name="l00260"></a>00260 <span class="comment">//                      printf(&quot;\n Porta %i, Retornando estado %i&quot;, pSerialPortConfig-&gt;ComPortNumber, SERIALCOM_SUCCESS);</span>
<a name="l00261"></a>00261                         <span class="keywordflow">return</span>(<a class="code" href="serialcom_8h.html#a5a0fdec1e76957e187bd57ebb437fb99">SERIALCOM_SUCCESS</a>);
<a name="l00262"></a>00262                 }
<a name="l00263"></a>00263                 <span class="keywordflow">if</span>( (status &amp; <a class="code" href="serialcom_8h.html#ae5c00c56a89414cda5b5261d2cd4fdde">SERIALCOM_STATUSMASK_ERROR_RX_FIFO</a>) ){
<a name="l00264"></a>00264                         *pData = inb(pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#a60c95986733fae1a71ab89bd97ebfed4">ComPortAddress</a> + 0);
<a name="l00265"></a>00265                         <span class="keywordflow">return</span>(<a class="code" href="serialcom_8h.html#a1a67c2540b6be0d469eebef6e9e96dcc">SERIALCOM_ERROR_RX_FIFO</a>);
<a name="l00266"></a>00266                 }
<a name="l00267"></a>00267                 <span class="keywordflow">if</span>( (status &amp; <a class="code" href="serialcom_8h.html#af27289e4b3313a8c4e760873675af13d">SERIALCOM_STATUSMASK_BREAK_INTERRUPT</a>) ){
<a name="l00268"></a>00268                         *pData = inb(pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#a60c95986733fae1a71ab89bd97ebfed4">ComPortAddress</a> + 0);
<a name="l00269"></a>00269                         <span class="keywordflow">return</span>(<a class="code" href="serialcom_8h.html#ade5b6f987d2dadd0131c5d27f8cc5f8a">SERIALCOM_ERROR_BREAK_INTERRUPT</a>);
<a name="l00270"></a>00270                 }
<a name="l00271"></a>00271                 <span class="keywordflow">if</span>( (status &amp; <a class="code" href="serialcom_8h.html#a38247958e5a046a9a90d90527732b7da">SERIALCOM_STATUSMASK_FRAMING_ERROR</a>) ){
<a name="l00272"></a>00272                         *pData = inb(pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#a60c95986733fae1a71ab89bd97ebfed4">ComPortAddress</a> + 0);
<a name="l00273"></a>00273                         <span class="keywordflow">return</span>(<a class="code" href="serialcom_8h.html#a359da035668c376c888820dd42cb91c9">SERIALCOM_ERROR_FRAMING_ERROR</a>);
<a name="l00274"></a>00274                 }
<a name="l00275"></a>00275                 <span class="keywordflow">if</span>( (status &amp; <a class="code" href="serialcom_8h.html#ad7af17851b352bdb2765fc1a00e039d9">SERIALCOM_STATUSMASK_PARITY_ERROR</a>) ){
<a name="l00276"></a>00276                         *pData = inb(pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#a60c95986733fae1a71ab89bd97ebfed4">ComPortAddress</a> + 0);
<a name="l00277"></a>00277                         <span class="keywordflow">return</span>(<a class="code" href="serialcom_8h.html#a1ea5eb01e40f61443fe872822b18ced7">SERIALCOM_ERROR_PARITY_ERROR</a>);
<a name="l00278"></a>00278                 }
<a name="l00279"></a>00279                 <span class="keywordflow">if</span>( (status &amp; <a class="code" href="serialcom_8h.html#a29210113c4ba476836bbc3aa7213cc41">SERIALCOM_STATUSMASK_OVERRUN_ERROR</a>) ){
<a name="l00280"></a>00280                         *pData = inb(pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#a60c95986733fae1a71ab89bd97ebfed4">ComPortAddress</a> + 0);
<a name="l00281"></a>00281                         <span class="keywordflow">return</span>(<a class="code" href="serialcom_8h.html#a868b290a06e47ca2d5bb2dd7e80c62af">SERIALCOM_ERROR_OVERRUN_ERROR</a>);
<a name="l00282"></a>00282                 }
<a name="l00283"></a>00283                 
<a name="l00284"></a>00284                 <a class="code" href="serialcom-sb16c1052pci-xenomai_8c.html#ab8562a5ce361317b4d7453a8354a5685">serialcom_delayus</a>(0.2*pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#ae5c4edc520a9a85a82daada36fb4ea40">FramePeriodUS</a>);
<a name="l00285"></a>00285                 ElapsedTime += 0.2*pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#ae5c4edc520a9a85a82daada36fb4ea40">FramePeriodUS</a>;
<a name="l00286"></a>00286 <span class="comment">//              printf(&quot;\n ElapsedTime = %f&quot;,ElapsedTime);</span>
<a name="l00287"></a>00287                 <span class="keywordflow">if</span>(ElapsedTime &gt;= MaximaEsperaUS){
<a name="l00288"></a>00288 <span class="comment">//                      printf(&quot;\n FILE = %s, LINE = %i&quot;,__FILE__,__LINE__);</span>
<a name="l00289"></a>00289 <span class="comment">//                      printf(&quot;\n Porta %i, Retornando estado %i&quot;, pSerialPortConfig-&gt;ComPortNumber, SERIALCOM_ERROR_MAXWAITFORRECEPTION);</span>
<a name="l00290"></a>00290                         <span class="keywordflow">return</span>(<a class="code" href="serialcom_8h.html#a7f072f5d8e091db1bfe224b4548d6205">SERIALCOM_ERROR_MAXWAITFORRECEPTION</a>);  <span class="comment">// Dado nao chegou no tempo estipulado.</span>
<a name="l00291"></a>00291                 }
<a name="l00292"></a>00292         }
<a name="l00293"></a>00293 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="aca6e0ddb69ed96c35f139ff05d5b3a72"></a><!-- doxytag: member="serialcom&#45;sb16c1052pci&#45;xenomai.c::serialcom_semsignal" ref="aca6e0ddb69ed96c35f139ff05d5b3a72" args="(PSERIALPORTCONFIG pSerialPortConfig)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void serialcom_semsignal </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structSERIALPORTCONFIG.html">PSERIALPORTCONFIG</a>&nbsp;</td>
          <td class="paramname"> <em>pSerialPortConfig</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Funcao que libera semforo que foi previamente cedido por serialcom_semwait para acessar a porta descrita por pSerialPortConfig. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>pSerialPortConfig</em>&nbsp;</td><td>Ponteiro para estrutura <a class="el" href="structSERIALPORTCONFIG.html">SERIALPORTCONFIG</a> que guarda informaes de configurao da porta serial no contexto do thread de chamada. Mesmo que uma dada porta serial seja utilizada por diversos threads, cada thread dever ter a sua estrutura <a class="el" href="structSERIALPORTCONFIG.html">SERIALPORTCONFIG</a>.. </td></tr>
  </table>
  </dd>
</dl>
<dl class="warning"><dt><b>Warning:</b></dt><dd>Se uma determinada porta somente gerenciada por um s thread, no h necessidade de se usar essas funes de semforo. As funes de semforo tm somente utilizade em situaes em que mais de um thread pode acessar a porta serial X, com X = 1, 2, 3 ou 4. </dd>
<dd>
Aps concluir o acesso porta serial cedido por essa funcao, deve-se chamar serialcom_semsignal para liberar o semforo </dd></dl>

<p>Definition at line <a class="el" href="serialcom-sb16c1052pci-xenomai_8c_source.html#l00178">178</a> of file <a class="el" href="serialcom-sb16c1052pci-xenomai_8c_source.html">serialcom-sb16c1052pci-xenomai.c</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00179"></a>00179 {
<a name="l00180"></a>00180         rt_sem_v(&amp;<a class="code" href="serialcom-sb16c1052pci-xenomai_8c.html#a74ad210af22afadd34ea631fd41bd860">pComPortSemaphores</a>[pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#afdab9b8ca1ed50f3970ac4d7215366e1">ComPortNumber</a>-1]);
<a name="l00181"></a>00181 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ac1deb0bc4fce44117f1d2b3aa0d78a2a"></a><!-- doxytag: member="serialcom&#45;sb16c1052pci&#45;xenomai.c::serialcom_semwait" ref="ac1deb0bc4fce44117f1d2b3aa0d78a2a" args="(PSERIALPORTCONFIG pSerialPortConfig)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void serialcom_semwait </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structSERIALPORTCONFIG.html">PSERIALPORTCONFIG</a>&nbsp;</td>
          <td class="paramname"> <em>pSerialPortConfig</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Funcao que aguarda semforo para acessar a porta descrita por pSerialPortConfig. Juntamente com serialcom_semsignal, pode-se garantir o acesso exclusivo de um thread porta serial. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>pSerialPortConfig</em>&nbsp;</td><td>Ponteiro para estrutura <a class="el" href="structSERIALPORTCONFIG.html">SERIALPORTCONFIG</a> que guarda informaes de configurao da porta serial no contexto do thread de chamada. Mesmo que uma dada porta serial seja utilizada por diversos threads, cada thread dever ter a sua estrutura <a class="el" href="structSERIALPORTCONFIG.html">SERIALPORTCONFIG</a>.. </td></tr>
  </table>
  </dd>
</dl>
<dl class="warning"><dt><b>Warning:</b></dt><dd>Se uma determinada porta somente gerenciada por um s thread, no h necessidade de se usar essas funes de semforo. As funes de semforo tm somente utilizade em situaes em que mais de um thread pode acessar a porta serial X, com X = 1, 2, 3 ou 4. </dd>
<dd>
Aps concluir o acesso porta serial cedido por essa funcao, deve-se chamar serialcom_semsignal para liberar o semforo </dd></dl>

<p>Definition at line <a class="el" href="serialcom-sb16c1052pci-xenomai_8c_source.html#l00164">164</a> of file <a class="el" href="serialcom-sb16c1052pci-xenomai_8c_source.html">serialcom-sb16c1052pci-xenomai.c</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00165"></a>00165 {
<a name="l00166"></a>00166         rt_sem_p(&amp;<a class="code" href="serialcom-sb16c1052pci-xenomai_8c.html#a74ad210af22afadd34ea631fd41bd860">pComPortSemaphores</a>[pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#afdab9b8ca1ed50f3970ac4d7215366e1">ComPortNumber</a>-1],TM_INFINITE);
<a name="l00167"></a>00167 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ac5dcc32914d203e1a81c377fef948014"></a><!-- doxytag: member="serialcom&#45;sb16c1052pci&#45;xenomai.c::serialcom_sendbyte" ref="ac5dcc32914d203e1a81c377fef948014" args="(PSERIALPORTCONFIG pSerialPortConfig, unsigned char *pData)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int serialcom_sendbyte </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structSERIALPORTCONFIG.html">PSERIALPORTCONFIG</a>&nbsp;</td>
          <td class="paramname"> <em>pSerialPortConfig</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned char *&nbsp;</td>
          <td class="paramname"> <em>pData</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Funcao que envia um byte apontado por pData pela porta serial descrita por pSerialPortConfig. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>pSerialPortConfig</em>&nbsp;</td><td>Ponteiro para estrutura <a class="el" href="structSERIALPORTCONFIG.html">SERIALPORTCONFIG</a> que guarda informaes de configurao da porta serial no contexto do thread de chamada. Mesmo que uma dada porta serial seja utilizada por diversos threads, cada thread dever ter a sua estrutura <a class="el" href="structSERIALPORTCONFIG.html">SERIALPORTCONFIG</a>. Se SERIALCOM_USE_RS485 = 1, ento o sinal RTS ser colocado em nvel lgico 1 enquanto durar o frame do byte enviado, permitindo assim ativar o driver externo de uma porta com conversor RS-485. Nessa situao, essa funcao somente retorna quando o byte tiver sido enviado. Caso contrrio, a funcao somente escrever no buffer de sada o byte apontado por pData, retornando em * seguida. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>pData</em>&nbsp;</td><td>Ponteiro para o byte que ser enviado. </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>SERIALCOM_SUCCESS : Dado escrito no registro de sada com sucesso. Entretanto, isso significa apenas que uma transmisso est em curso. Para se certificar de que o dado foi efetivamente transmitido, deve-se fazer uso da funcao <a class="el" href="serialcom-sb16c1052pci-xenomai_8c.html#a7ad801f3b47f1ee0e0cf90ab78a20983">serialcom_status()</a> </dd>
<dd>
SERIALCOM_ERROR_MAXWAITENDOFTRANSMISSION : Situao de erro em que a funcao ficou aguardando por um perodo de at 5 frames para disponibilizao do registro de sada da porta </dd></dl>
<dl class="warning"><dt><b>Warning:</b></dt><dd>Essa funcao fica bloqueada enquanto o ltimo byte escrito no buffer de sada ainda no tiver sido enviado. </dd></dl>

<p>Definition at line <a class="el" href="serialcom-sb16c1052pci-xenomai_8c_source.html#l00195">195</a> of file <a class="el" href="serialcom-sb16c1052pci-xenomai_8c_source.html">serialcom-sb16c1052pci-xenomai.c</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00196"></a>00196 {
<a name="l00197"></a>00197         <span class="keywordtype">int</span> contador;
<a name="l00198"></a>00198 <span class="preprocessor">        #if SERIALCOM_USE_RS485</span>
<a name="l00199"></a>00199 <span class="preprocessor"></span>        <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> dado;
<a name="l00200"></a>00200 <span class="preprocessor">        #endif</span>
<a name="l00201"></a>00201 <span class="preprocessor"></span>
<a name="l00202"></a>00202         contador = 0;
<a name="l00203"></a>00203         <span class="keywordflow">while</span>(!(<a class="code" href="serialcom-sb16c1052pci-xenomai_8c.html#a7ad801f3b47f1ee0e0cf90ab78a20983">serialcom_status</a>(pSerialPortConfig) &amp; <a class="code" href="serialcom_8h.html#a3db72161c536946e1df76e9562447d5f">SERIALCOM_STATUSMASK_EMPTY_DH_REGISTERS</a>))
<a name="l00204"></a>00204         {
<a name="l00205"></a>00205                 <a class="code" href="serialcom-sb16c1052pci-xenomai_8c.html#ab8562a5ce361317b4d7453a8354a5685">serialcom_delayus</a>(0.2*pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#ae5c4edc520a9a85a82daada36fb4ea40">FramePeriodUS</a>); 
<a name="l00206"></a>00206                 <span class="keywordflow">if</span>(++contador&gt;10) <span class="keywordflow">return</span>(<a class="code" href="serialcom_8h.html#ab9c6f98c58213b3a22c38c1296070f30">SERIALCOM_ERROR_MAXWAITENDOFTRANSMISSION</a>);
<a name="l00207"></a>00207         } <span class="comment">// Espera fim da ultima transmissao</span>
<a name="l00208"></a>00208 
<a name="l00209"></a>00209 <span class="preprocessor">        #if SERIALCOM_USE_RS485</span>
<a name="l00210"></a>00210 <span class="preprocessor"></span>        dado = inb(pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#a60c95986733fae1a71ab89bd97ebfed4">ComPortAddress</a> + 4);
<a name="l00211"></a>00211         dado = dado &amp; (~0x02);
<a name="l00212"></a>00212         outb(dado, pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#a60c95986733fae1a71ab89bd97ebfed4">ComPortAddress</a> + 4);  <span class="comment">//setar RTS = 1 mantendo OUT2</span>
<a name="l00213"></a>00213 <span class="preprocessor">        #endif</span>
<a name="l00214"></a>00214 <span class="preprocessor"></span>        
<a name="l00215"></a>00215         outb(*pData, pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#a60c95986733fae1a71ab89bd97ebfed4">ComPortAddress</a> + 0); <span class="comment">// Envia.</span>
<a name="l00216"></a>00216         
<a name="l00217"></a>00217 <span class="preprocessor">        #if SERIALCOM_USE_RS485</span>
<a name="l00218"></a>00218 <span class="preprocessor"></span><span class="comment">//      serialcom_delayus(pSerialPortConfig-&gt;FramePeriodUS); // Espera o periodo de uma transmisso</span>
<a name="l00219"></a>00219         contador = 0;
<a name="l00220"></a>00220         <span class="keywordflow">while</span>(!(<a class="code" href="serialcom-sb16c1052pci-xenomai_8c.html#a7ad801f3b47f1ee0e0cf90ab78a20983">serialcom_status</a>(pSerialPortConfig) &amp; SERIALCOM_STATUSMASK_EMPTY_DH_REGISTERS))
<a name="l00221"></a>00221         {
<a name="l00222"></a>00222                 <a class="code" href="serialcom-sb16c1052pci-xenomai_8c.html#ab8562a5ce361317b4d7453a8354a5685">serialcom_delayus</a>(0.2*pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#ae5c4edc520a9a85a82daada36fb4ea40">FramePeriodUS</a>);
<a name="l00223"></a>00223                 <span class="keywordflow">if</span>(++contador&gt;10) <span class="keywordflow">return</span>(<a class="code" href="serialcom_8h.html#ab9c6f98c58213b3a22c38c1296070f30">SERIALCOM_ERROR_MAXWAITENDOFTRANSMISSION</a>);
<a name="l00224"></a>00224         } <span class="comment">// Espera fim da ultima transmissao</span>
<a name="l00225"></a>00225 
<a name="l00226"></a>00226         dado = inb(pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#a60c95986733fae1a71ab89bd97ebfed4">ComPortAddress</a> + 4);
<a name="l00227"></a>00227         dado = dado | (0x02);
<a name="l00228"></a>00228         outb(dado, pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#a60c95986733fae1a71ab89bd97ebfed4">ComPortAddress</a> + 4);  <span class="comment">//setar RTS = 0 mantendo OUT2</span>
<a name="l00229"></a>00229 <span class="preprocessor">        #endif</span>
<a name="l00230"></a>00230 <span class="preprocessor"></span>
<a name="l00231"></a>00231         <span class="keywordflow">return</span> <a class="code" href="serialcom_8h.html#a5a0fdec1e76957e187bd57ebb437fb99">SERIALCOM_SUCCESS</a>;
<a name="l00232"></a>00232 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a7ad801f3b47f1ee0e0cf90ab78a20983"></a><!-- doxytag: member="serialcom&#45;sb16c1052pci&#45;xenomai.c::serialcom_status" ref="a7ad801f3b47f1ee0e0cf90ab78a20983" args="(PSERIALPORTCONFIG pSerialPortConfig)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int serialcom_status </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structSERIALPORTCONFIG.html">PSERIALPORTCONFIG</a>&nbsp;</td>
          <td class="paramname"> <em>pSerialPortConfig</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Funcao que l o registro de status da porta serial descrita por pSerialPortConfig. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>pSerialPortConfig</em>&nbsp;</td><td>Ponteiro para estrutura <a class="el" href="structSERIALPORTCONFIG.html">SERIALPORTCONFIG</a> que guarda informaes de configurao da porta serial no contexto do thread de chamada. </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>O valor de retorno tem os bits setados conforme que o dado foi efetivamente enviadoos eventos que ocorreram com a porta serial, que podem ser testados usando um teste lgico E bit a bit com as seguintes mscaras: </dd>
<dd>
SERIALCOM_STATUSMASK_ERROR_RX_FIFO </dd>
<dd>
SERIALCOM_STATUSMASK_EMPTY_DH_REGISTERS </dd>
<dd>
SERIALCOM_STATUSMASK_EMPTY_TX_REGISTER </dd>
<dd>
SERIALCOM_STATUSMASK_BREAK_INTERRUPT </dd>
<dd>
SERIALCOM_STATUSMASK_FRAMING_ERROR </dd>
<dd>
SERIALCOM_STATUSMASK_PARITY_ERROR </dd>
<dd>
SERIALCOM_STATUSMASK_OVERRUN_ERROR </dd>
<dd>
SERIALCOM_STATUSMASK_RX_DATA_READY </dd>
<dd>
As mscaras acima correspondem a eventos que so detalhados em <a href="http://www.beyondlogic.org/serial/serial.htm">http://www.beyondlogic.org/serial/serial.htm</a> </dd></dl>

<p>Definition at line <a class="el" href="serialcom-sb16c1052pci-xenomai_8c_source.html#l00311">311</a> of file <a class="el" href="serialcom-sb16c1052pci-xenomai_8c_source.html">serialcom-sb16c1052pci-xenomai.c</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00312"></a>00312 {
<a name="l00313"></a>00313         <span class="keywordflow">return</span> inb(pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#a60c95986733fae1a71ab89bd97ebfed4">ComPortAddress</a> + 5);
<a name="l00314"></a>00314 }
</pre></div></p>

</div>
</div>
<hr/><h2>Variable Documentation</h2>
<a class="anchor" id="a74ad210af22afadd34ea631fd41bd860"></a><!-- doxytag: member="serialcom&#45;sb16c1052pci&#45;xenomai.c::pComPortSemaphores" ref="a74ad210af22afadd34ea631fd41bd860" args="[4]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">SEM * <a class="el" href="serialcom_8c.html#a34390a6151353a5966040a92b821516d">pComPortSemaphores</a>[4]</td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Vetor de ponteiros para semaforos. Cada elemento desse vetor eh um ponteiro para o semaforo associado aa porta X, com X = 1, 2, 3 ou 4. Os semaforos de cada porta sao iniciados na chamada aa funcao <a class="el" href="serialcom-sb16c1052pci-xenomai_8c.html#a5eb7bbd8dec689b7e1943f71a54ed89b">serialcom_init()</a>. Para uso interno pelas funcoes <a class="el" href="serialcom-sb16c1052pci-xenomai_8c.html#ac1deb0bc4fce44117f1d2b3aa0d78a2a">serialcom_semwait()</a> e <a class="el" href="serialcom-sb16c1052pci-xenomai_8c.html#aca6e0ddb69ed96c35f139ff05d5b3a72">serialcom_semsignal()</a>. </p>

<p>Definition at line <a class="el" href="serialcom-sb16c1052pci-xenomai_8c_source.html#l00044">44</a> of file <a class="el" href="serialcom-sb16c1052pci-xenomai_8c_source.html">serialcom-sb16c1052pci-xenomai.c</a>.</p>

</div>
</div>
</div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Fri Jan 14 10:33:52 2011 for mmrobot-server by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
