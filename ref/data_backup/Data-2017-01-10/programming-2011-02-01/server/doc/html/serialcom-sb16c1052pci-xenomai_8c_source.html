<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>mmrobot-server: serialcom-sb16c1052pci-xenomai.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>serialcom-sb16c1052pci-xenomai.c</h1><a href="serialcom-sb16c1052pci-xenomai_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*******************************************************************************</span>
<a name="l00002"></a>00002 <span class="comment">* \file serialcom-sb16c1052pci.c</span>
<a name="l00003"></a>00003 <span class="comment">* \brief  Implementa modulo basico de acesso ao controlador de porta serial sb16c1052pci.</span>
<a name="l00004"></a>00004 <span class="comment">// Observacoes:</span>
<a name="l00005"></a>00005 <span class="comment">        - Deve instalar pciutils e libpci-dev</span>
<a name="l00006"></a>00006 <span class="comment">        - Consultado  /usr/share/doc/pciutils/examples/example.c</span>
<a name="l00007"></a>00007 <span class="comment">        - Usado man pcilib</span>
<a name="l00008"></a>00008 <span class="comment">        - http://alenitchev.wordpress.com/page/2/</span>
<a name="l00009"></a>00009 <span class="comment">        - lspci -vv verificar linha: 03:01.0 Serial controller: Systembase Co Ltd Device 4d02 (rev b0) (prog-if 02)</span>
<a name="l00010"></a>00010 <span class="comment">        - DB9 pinout:</span>
<a name="l00011"></a>00011 <span class="comment">        * RS 485 A Tx signal (+): pin 3 </span>
<a name="l00012"></a>00012 <span class="comment">        * RS 485 B Tx signal (-): pin 8 </span>
<a name="l00013"></a>00013 <span class="comment">        * RS 485 A Rx signal (+): pin 2 </span>
<a name="l00014"></a>00014 <span class="comment">        * RS 485 B Rx signal (-): pin 7 </span>
<a name="l00015"></a>00015 <span class="comment">*******************************************************************************/</span>
<a name="l00016"></a>00016 
<a name="l00017"></a>00017 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include &lt;signal.h&gt;</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include &lt;sys/io.h&gt;</span> 
<a name="l00021"></a>00021 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include &lt;sys/mman.h&gt;</span>
<a name="l00023"></a>00023 
<a name="l00024"></a>00024 <span class="preprocessor">#include &lt;native/task.h&gt;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &lt;native/timer.h&gt;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &lt;native/sem.h&gt;</span>
<a name="l00027"></a>00027 
<a name="l00028"></a>00028 <span class="preprocessor">#include &lt;linux/pci.h&gt;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &lt;linux/pci_regs.h&gt;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &lt;linux/virtio_pci.h&gt;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;pci/pci.h&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;pci/config.h&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;pci/header.h&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;pci/types.h&gt;</span>
<a name="l00035"></a>00035 
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;<a class="code" href="serialcom_8h.html">serialcom.h</a>&quot;</span> 
<a name="l00037"></a>00037 
<a name="l00038"></a><a class="code" href="serialcom-sb16c1052pci-xenomai_8c.html#a583579ba38499640c937c74b3b78a759">00038</a> <span class="preprocessor">#define PCI_VENDOR_ID_MULTIPORT         0x14A1</span>
<a name="l00039"></a><a class="code" href="serialcom-sb16c1052pci-xenomai_8c.html#a51f9c3fd33083b796c8db0b91d25dfd2">00039</a> <span class="preprocessor"></span><span class="preprocessor">#define PCI_DEVICE_ID_MP1               0x4d01</span>
<a name="l00040"></a><a class="code" href="serialcom-sb16c1052pci-xenomai_8c.html#a36109a3edeafb33def0bb6e2f118f94c">00040</a> <span class="preprocessor"></span><span class="preprocessor">#define PCI_DEVICE_ID_MP2               0x4d02</span>
<a name="l00041"></a>00041 <span class="preprocessor"></span>
<a name="l00044"></a><a class="code" href="serialcom-sb16c1052pci-xenomai_8c.html#a74ad210af22afadd34ea631fd41bd860">00044</a> RT_SEM <a class="code" href="serialcom-sb16c1052pci-xenomai_8c.html#a74ad210af22afadd34ea631fd41bd860">pComPortSemaphores</a>[4]; 
<a name="l00045"></a>00045 
<a name="l00046"></a>00046 <span class="comment">// funcões de uso interno apenas</span>
<a name="l00047"></a>00047 <span class="keywordtype">int</span> <a class="code" href="serialcom-sb16c1052pci-xenomai_8c.html#ac47f39cfcf8738d1da7022b1f466fcab">serialcom_pci_find_device</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> vendor_id, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> device_id, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *pbase_address, <span class="keyword">struct</span> pci_access **ppacc);
<a name="l00048"></a>00048 <span class="keywordtype">void</span> <a class="code" href="serialcom-sb16c1052pci-xenomai_8c.html#ad43e67f6cf73e5f0ca1a1490f4e68d6f">serialcom_pci_close_device</a>(<span class="keyword">struct</span> pci_access *pacc);
<a name="l00049"></a>00049 
<a name="l00050"></a><a class="code" href="serialcom-sb16c1052pci-xenomai_8c.html#ab8562a5ce361317b4d7453a8354a5685">00050</a> <span class="preprocessor">#define serialcom_delayus(a) rt_task_sleep((RTIME)((a)*1000))</span>
<a name="l00051"></a>00051 <span class="preprocessor"></span>
<a name="l00052"></a>00052 <span class="comment">/************* Rotinas Genericas de Manipulacao da porta serial com acesso externo *****************/</span>
<a name="l00066"></a><a class="code" href="serialcom_8h.html#a5eb7bbd8dec689b7e1943f71a54ed89b">00066</a> <span class="keywordtype">int</span> <a class="code" href="serialcom-sb16c1052pci-xenomai_8c.html#a5eb7bbd8dec689b7e1943f71a54ed89b">serialcom_init</a>(<a class="code" href="structSERIALPORTCONFIG.html">PSERIALPORTCONFIG</a> pSerialPortConfig, <span class="keywordtype">int</span> ComPortNumber, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> ComPortBPS)
<a name="l00067"></a>00067 {
<a name="l00068"></a>00068         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> BPSClockDivisor;
<a name="l00069"></a>00069         <span class="keywordtype">float</span> BPSPrecision;
<a name="l00070"></a>00070         <span class="keywordtype">char</span> semname[50];
<a name="l00071"></a>00071 
<a name="l00072"></a>00072         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> board_base_address;
<a name="l00073"></a>00073         <span class="keyword">struct </span>pci_access *pacc;
<a name="l00074"></a>00074 
<a name="l00075"></a>00075         <span class="keywordflow">if</span>((ComPortNumber&lt;0) || (ComPortNumber&gt;2)){
<a name="l00076"></a>00076                 <span class="keywordflow">return</span> <a class="code" href="serialcom_8h.html#a72c589a0e28e387b55e20336f2e93021">SERIALCOM_ERROR_INCORRECTPORTNUMBER</a>;
<a name="l00077"></a>00077         }
<a name="l00078"></a>00078         
<a name="l00079"></a>00079         printf(<span class="stringliteral">&quot;\n*** probing PCI devices:&quot;</span>);
<a name="l00080"></a>00080         <span class="keywordflow">if</span>(!<a class="code" href="serialcom-sb16c1052pci-xenomai_8c.html#ac47f39cfcf8738d1da7022b1f466fcab">serialcom_pci_find_device</a>(<a class="code" href="serialcom-sb16c1052pci-xenomai_8c.html#a583579ba38499640c937c74b3b78a759">PCI_VENDOR_ID_MULTIPORT</a>, <a class="code" href="serialcom-sb16c1052pci-xenomai_8c.html#a36109a3edeafb33def0bb6e2f118f94c">PCI_DEVICE_ID_MP2</a>, &amp;board_base_address, &amp;pacc)){
<a name="l00081"></a>00081                 printf(<span class="stringliteral">&quot;\n    device not found !&quot;</span>);
<a name="l00082"></a>00082                 <span class="keywordflow">return</span> <a class="code" href="serialcom_8h.html#a0efc6c408872166b02c815ca31b9f89e">SERIALCOM_ERROR_DEVICENOTFOUND</a>;
<a name="l00083"></a>00083         }
<a name="l00084"></a>00084         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> board_port1_base_address;
<a name="l00085"></a>00085         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> board_port2_base_address;
<a name="l00086"></a>00086         board_port1_base_address = board_base_address;
<a name="l00087"></a>00087         board_port2_base_address = board_base_address+8;
<a name="l00088"></a>00088         printf(<span class="stringliteral">&quot;\n*** board_port1_base_address: %Xh&quot;</span>,(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)board_port1_base_address);
<a name="l00089"></a>00089         printf(<span class="stringliteral">&quot;\n*** board_port2_base_address: %Xh&quot;</span>,(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)board_port2_base_address);
<a name="l00090"></a>00090         
<a name="l00091"></a>00091         <a class="code" href="serialcom-sb16c1052pci-xenomai_8c.html#ad43e67f6cf73e5f0ca1a1490f4e68d6f">serialcom_pci_close_device</a>(pacc);
<a name="l00092"></a>00092 
<a name="l00093"></a>00093         pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#afdab9b8ca1ed50f3970ac4d7215366e1">ComPortNumber</a> = ComPortNumber; 
<a name="l00094"></a>00094         pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#a60c95986733fae1a71ab89bd97ebfed4">ComPortAddress</a> = board_base_address+8*(ComPortNumber-1); 
<a name="l00095"></a>00095         
<a name="l00096"></a>00096 
<a name="l00097"></a>00097         pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#aa6dea3f4c4292d4be56bbf2d7ac4c196">ComPortBPS</a> = ComPortBPS;
<a name="l00098"></a>00098         pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#ae5c4edc520a9a85a82daada36fb4ea40">FramePeriodUS</a> = (1e7)/(((<span class="keywordtype">float</span>)(ComPortBPS)));
<a name="l00099"></a>00099 
<a name="l00100"></a>00100         BPSClockDivisor = 921600 / ComPortBPS;
<a name="l00101"></a>00101         BPSPrecision = (((double)(ComPortBPS)) - 921600.0/BPSClockDivisor)/((double)(ComPortBPS));
<a name="l00102"></a>00102         <span class="keywordflow">if</span>(fabs(BPSPrecision) &gt; <a class="code" href="serialcom_8h.html#a0eeee6b0469b12865344fb8e1dc7ff54">SERIALCOM_MAXBPSPRECISION</a>){
<a name="l00103"></a>00103                 <span class="keywordflow">return</span> <a class="code" href="serialcom_8h.html#a302cedb96f53be4d397c4307326a4cfa">SERIALCOM_ERROR_MAXBPSPRECISION</a>;
<a name="l00104"></a>00104         }
<a name="l00105"></a>00105 
<a name="l00106"></a>00106     <span class="keywordflow">if</span>(iopl(3)&lt;0){
<a name="l00107"></a>00107                 printf(<span class="stringliteral">&quot;seriallib_iniciar: iopl error&quot;</span>);
<a name="l00108"></a>00108                 <span class="keywordflow">return</span> <a class="code" href="serialcom_8h.html#a264fd1a738f038a013c61212b7ec11d3">SERIALCOM_ERROR_IOPL</a>;
<a name="l00109"></a>00109         }
<a name="l00110"></a>00110 
<a name="l00111"></a>00111         outb(0, pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#a60c95986733fae1a71ab89bd97ebfed4">ComPortAddress</a> + 1);         <span class="comment">// Desativar interrupes </span>
<a name="l00112"></a>00112         outb(0x80, pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#a60c95986733fae1a71ab89bd97ebfed4">ComPortAddress</a> + 3);      <span class="comment">// DLAB ON </span>
<a name="l00113"></a>00113         outb((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>)(BPSClockDivisor &amp; 0xFF), pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#a60c95986733fae1a71ab89bd97ebfed4">ComPortAddress</a> + 0);   <span class="comment">// Baud Rate - DL Byte </span>
<a name="l00114"></a>00114         outb((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>)((BPSClockDivisor &gt;&gt; 8) &amp; 0xFF), pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#a60c95986733fae1a71ab89bd97ebfed4">ComPortAddress</a> + 1);    <span class="comment">// Baud Rate - DH Byte </span>
<a name="l00115"></a>00115         outb(0x03, pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#a60c95986733fae1a71ab89bd97ebfed4">ComPortAddress</a> + 3);      <span class="comment">// LCR: 8 Bits, No Parity, 1 Stop Bit </span>
<a name="l00116"></a>00116         outb(0xC7, pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#a60c95986733fae1a71ab89bd97ebfed4">ComPortAddress</a> + 2);      <span class="comment">// FIFO Control: 64 bytes TX e RX FIFO, limpa TX e RX fifos</span>
<a name="l00117"></a>00117         outb(0x0B, pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#a60c95986733fae1a71ab89bd97ebfed4">ComPortAddress</a> + 4);      <span class="comment">// MCR: Ativa DTR, RTS = 0, e OUT2      </span>
<a name="l00118"></a>00118 
<a name="l00119"></a>00119         <span class="keywordtype">char</span> tmp_lcr;
<a name="l00120"></a>00120         
<a name="l00121"></a>00121         tmp_lcr = inb(pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#a60c95986733fae1a71ab89bd97ebfed4">ComPortAddress</a> + 3);            <span class="comment">// get LCR initial value</span>
<a name="l00122"></a>00122         outb(tmp_lcr | 0xBF, pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#a60c95986733fae1a71ab89bd97ebfed4">ComPortAddress</a> + 3); <span class="comment">// LCR set 0xBF</span>
<a name="l00123"></a>00123 
<a name="l00124"></a>00124         outb(0xA4, pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#a60c95986733fae1a71ab89bd97ebfed4">ComPortAddress</a> + 0);                       <span class="comment">// select page 3</span>
<a name="l00125"></a>00125         <span class="comment">// set ATR: </span>
<a name="l00126"></a>00126         <span class="comment">//              * habilita controle automatico do driver TX, deixando a linha desativada quando não transmite.</span>
<a name="l00127"></a>00127         <span class="comment">//              * habilita controle automatico do driver RX, deixando a linha desativada quando não transmite.</span>
<a name="l00128"></a>00128 <span class="comment">//      outb(0x03 | (1&lt;&lt;5) | (1&lt;&lt;4), pSerialPortConfig-&gt;ComPortAddress + 1);  </span>
<a name="l00129"></a>00129         outb(0x03 | (1&lt;&lt;5) | (1&lt;&lt;4) | (1&lt;&lt;6), pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#a60c95986733fae1a71ab89bd97ebfed4">ComPortAddress</a> + 1);  
<a name="l00130"></a>00130 <span class="comment">//      outb(0x03 | (1&lt;&lt;5) | (1&lt;&lt;4) | (1&lt;&lt;7) | (1&lt;&lt;6), pSerialPortConfig-&gt;ComPortAddress + 1);</span>
<a name="l00131"></a>00131   
<a name="l00132"></a>00132         outb(0xA5, pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#a60c95986733fae1a71ab89bd97ebfed4">ComPortAddress</a> + 0);                       <span class="comment">// select page 4</span>
<a name="l00133"></a>00133         <span class="comment">// set AFR: </span>
<a name="l00134"></a>00134         <span class="comment">//              * habilita FIFO de 256 bytes.</span>
<a name="l00135"></a>00135         outb(0x01, pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#a60c95986733fae1a71ab89bd97ebfed4">ComPortAddress</a> + 1);  
<a name="l00136"></a>00136 
<a name="l00137"></a>00137         outb(tmp_lcr, pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#a60c95986733fae1a71ab89bd97ebfed4">ComPortAddress</a> + 3);            <span class="comment">// LCR set to initial value</span>
<a name="l00138"></a>00138 
<a name="l00139"></a>00139         sprintf(semname,<span class="stringliteral">&quot;CoSem%i&quot;</span>,ComPortNumber);
<a name="l00140"></a>00140         <span class="comment">//printf(&quot;\n semname = %s&quot;,semname);</span>
<a name="l00141"></a>00141         rt_sem_create(&amp;<a class="code" href="serialcom-sb16c1052pci-xenomai_8c.html#a74ad210af22afadd34ea631fd41bd860">pComPortSemaphores</a>[ComPortNumber-1],semname,1,S_FIFO);
<a name="l00142"></a>00142         <span class="keywordflow">return</span> <a class="code" href="serialcom_8h.html#a5a0fdec1e76957e187bd57ebb437fb99">SERIALCOM_SUCCESS</a>;
<a name="l00143"></a>00143 
<a name="l00144"></a>00144         <span class="keywordflow">return</span> <a class="code" href="serialcom_8h.html#a5a0fdec1e76957e187bd57ebb437fb99">SERIALCOM_SUCCESS</a>;
<a name="l00145"></a>00145 }
<a name="l00146"></a>00146 
<a name="l00147"></a><a class="code" href="serialcom_8h.html#a480f412a5b77f8ad7966a267b4c26f89">00147</a> <span class="keywordtype">int</span> <a class="code" href="serialcom-sb16c1052pci-xenomai_8c.html#a480f412a5b77f8ad7966a267b4c26f89">serialcom_close</a>(<a class="code" href="structSERIALPORTCONFIG.html">PSERIALPORTCONFIG</a> pSerialPortConfig)
<a name="l00148"></a>00148 {
<a name="l00149"></a>00149         rt_sem_delete(&amp;<a class="code" href="serialcom-sb16c1052pci-xenomai_8c.html#a74ad210af22afadd34ea631fd41bd860">pComPortSemaphores</a>[pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#afdab9b8ca1ed50f3970ac4d7215366e1">ComPortNumber</a>-1]);
<a name="l00150"></a>00150 
<a name="l00151"></a>00151         <span class="keywordflow">return</span> <a class="code" href="serialcom_8h.html#a5a0fdec1e76957e187bd57ebb437fb99">SERIALCOM_SUCCESS</a>;
<a name="l00152"></a>00152 }
<a name="l00153"></a>00153 
<a name="l00164"></a><a class="code" href="serialcom_8h.html#ac1deb0bc4fce44117f1d2b3aa0d78a2a">00164</a> <span class="keywordtype">void</span> <a class="code" href="serialcom-sb16c1052pci-xenomai_8c.html#ac1deb0bc4fce44117f1d2b3aa0d78a2a">serialcom_semwait</a>(<a class="code" href="structSERIALPORTCONFIG.html">PSERIALPORTCONFIG</a> pSerialPortConfig)
<a name="l00165"></a>00165 {
<a name="l00166"></a>00166         rt_sem_p(&amp;<a class="code" href="serialcom-sb16c1052pci-xenomai_8c.html#a74ad210af22afadd34ea631fd41bd860">pComPortSemaphores</a>[pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#afdab9b8ca1ed50f3970ac4d7215366e1">ComPortNumber</a>-1],TM_INFINITE);
<a name="l00167"></a>00167 }
<a name="l00168"></a>00168 
<a name="l00178"></a><a class="code" href="serialcom_8h.html#aca6e0ddb69ed96c35f139ff05d5b3a72">00178</a> <span class="keywordtype">void</span> <a class="code" href="serialcom-sb16c1052pci-xenomai_8c.html#aca6e0ddb69ed96c35f139ff05d5b3a72">serialcom_semsignal</a>(<a class="code" href="structSERIALPORTCONFIG.html">PSERIALPORTCONFIG</a> pSerialPortConfig)
<a name="l00179"></a>00179 {
<a name="l00180"></a>00180         rt_sem_v(&amp;<a class="code" href="serialcom-sb16c1052pci-xenomai_8c.html#a74ad210af22afadd34ea631fd41bd860">pComPortSemaphores</a>[pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#afdab9b8ca1ed50f3970ac4d7215366e1">ComPortNumber</a>-1]);
<a name="l00181"></a>00181 }
<a name="l00182"></a>00182 
<a name="l00195"></a><a class="code" href="serialcom_8h.html#ac5dcc32914d203e1a81c377fef948014">00195</a> <span class="keywordtype">int</span> <a class="code" href="serialcom-sb16c1052pci-xenomai_8c.html#ac5dcc32914d203e1a81c377fef948014">serialcom_sendbyte</a>(<a class="code" href="structSERIALPORTCONFIG.html">PSERIALPORTCONFIG</a> pSerialPortConfig, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *pData)
<a name="l00196"></a>00196 {
<a name="l00197"></a>00197         <span class="keywordtype">int</span> contador;
<a name="l00198"></a>00198 <span class="preprocessor">        #if SERIALCOM_USE_RS485</span>
<a name="l00199"></a>00199 <span class="preprocessor"></span>        <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> dado;
<a name="l00200"></a>00200 <span class="preprocessor">        #endif</span>
<a name="l00201"></a>00201 <span class="preprocessor"></span>
<a name="l00202"></a>00202         contador = 0;
<a name="l00203"></a>00203         <span class="keywordflow">while</span>(!(<a class="code" href="serialcom-sb16c1052pci-xenomai_8c.html#a7ad801f3b47f1ee0e0cf90ab78a20983">serialcom_status</a>(pSerialPortConfig) &amp; <a class="code" href="serialcom_8h.html#a3db72161c536946e1df76e9562447d5f">SERIALCOM_STATUSMASK_EMPTY_DH_REGISTERS</a>))
<a name="l00204"></a>00204         {
<a name="l00205"></a>00205                 <a class="code" href="serialcom-sb16c1052pci-xenomai_8c.html#ab8562a5ce361317b4d7453a8354a5685">serialcom_delayus</a>(0.2*pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#ae5c4edc520a9a85a82daada36fb4ea40">FramePeriodUS</a>); 
<a name="l00206"></a>00206                 <span class="keywordflow">if</span>(++contador&gt;10) <span class="keywordflow">return</span>(<a class="code" href="serialcom_8h.html#ab9c6f98c58213b3a22c38c1296070f30">SERIALCOM_ERROR_MAXWAITENDOFTRANSMISSION</a>);
<a name="l00207"></a>00207         } <span class="comment">// Espera fim da ultima transmissao</span>
<a name="l00208"></a>00208 
<a name="l00209"></a>00209 <span class="preprocessor">        #if SERIALCOM_USE_RS485</span>
<a name="l00210"></a>00210 <span class="preprocessor"></span>        dado = inb(pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#a60c95986733fae1a71ab89bd97ebfed4">ComPortAddress</a> + 4);
<a name="l00211"></a>00211         dado = dado &amp; (~0x02);
<a name="l00212"></a>00212         outb(dado, pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#a60c95986733fae1a71ab89bd97ebfed4">ComPortAddress</a> + 4);  <span class="comment">//setar RTS = 1 mantendo OUT2</span>
<a name="l00213"></a>00213 <span class="preprocessor">        #endif</span>
<a name="l00214"></a>00214 <span class="preprocessor"></span>        
<a name="l00215"></a>00215         outb(*pData, pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#a60c95986733fae1a71ab89bd97ebfed4">ComPortAddress</a> + 0); <span class="comment">// Envia.</span>
<a name="l00216"></a>00216         
<a name="l00217"></a>00217 <span class="preprocessor">        #if SERIALCOM_USE_RS485</span>
<a name="l00218"></a>00218 <span class="preprocessor"></span><span class="comment">//      serialcom_delayus(pSerialPortConfig-&gt;FramePeriodUS); // Espera o periodo de uma transmisso</span>
<a name="l00219"></a>00219         contador = 0;
<a name="l00220"></a>00220         <span class="keywordflow">while</span>(!(<a class="code" href="serialcom-sb16c1052pci-xenomai_8c.html#a7ad801f3b47f1ee0e0cf90ab78a20983">serialcom_status</a>(pSerialPortConfig) &amp; SERIALCOM_STATUSMASK_EMPTY_DH_REGISTERS))
<a name="l00221"></a>00221         {
<a name="l00222"></a>00222                 <a class="code" href="serialcom-sb16c1052pci-xenomai_8c.html#ab8562a5ce361317b4d7453a8354a5685">serialcom_delayus</a>(0.2*pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#ae5c4edc520a9a85a82daada36fb4ea40">FramePeriodUS</a>);
<a name="l00223"></a>00223                 <span class="keywordflow">if</span>(++contador&gt;10) <span class="keywordflow">return</span>(<a class="code" href="serialcom_8h.html#ab9c6f98c58213b3a22c38c1296070f30">SERIALCOM_ERROR_MAXWAITENDOFTRANSMISSION</a>);
<a name="l00224"></a>00224         } <span class="comment">// Espera fim da ultima transmissao</span>
<a name="l00225"></a>00225 
<a name="l00226"></a>00226         dado = inb(pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#a60c95986733fae1a71ab89bd97ebfed4">ComPortAddress</a> + 4);
<a name="l00227"></a>00227         dado = dado | (0x02);
<a name="l00228"></a>00228         outb(dado, pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#a60c95986733fae1a71ab89bd97ebfed4">ComPortAddress</a> + 4);  <span class="comment">//setar RTS = 0 mantendo OUT2</span>
<a name="l00229"></a>00229 <span class="preprocessor">        #endif</span>
<a name="l00230"></a>00230 <span class="preprocessor"></span>
<a name="l00231"></a>00231         <span class="keywordflow">return</span> <a class="code" href="serialcom_8h.html#a5a0fdec1e76957e187bd57ebb437fb99">SERIALCOM_SUCCESS</a>;
<a name="l00232"></a>00232 }
<a name="l00233"></a>00233 
<a name="l00246"></a><a class="code" href="serialcom_8h.html#a54d13404ad9f206887f345c49c0b4499">00246</a> <span class="keywordtype">int</span> <a class="code" href="serialcom-sb16c1052pci-xenomai_8c.html#aaae4ccb4f6a36146c4191a76f15c875c">serialcom_receivebyte</a>(<a class="code" href="structSERIALPORTCONFIG.html">PSERIALPORTCONFIG</a> pSerialPortConfig, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *pData, <span class="keywordtype">double</span> MaximaEsperaUS)
<a name="l00247"></a>00247 {
<a name="l00248"></a>00248         <span class="keywordtype">double</span>  ElapsedTime;
<a name="l00249"></a>00249         <span class="keywordtype">int</span> status;
<a name="l00250"></a>00250 
<a name="l00251"></a>00251         <span class="keywordflow">if</span>(MaximaEsperaUS&lt;0) MaximaEsperaUS = 0; <span class="comment">// Espera minima de 0 us.</span>
<a name="l00252"></a>00252 
<a name="l00253"></a>00253         ElapsedTime = 0.0;
<a name="l00254"></a>00254         <span class="keywordflow">while</span>(1)
<a name="l00255"></a>00255         {
<a name="l00256"></a>00256                 status = <a class="code" href="serialcom-sb16c1052pci-xenomai_8c.html#a7ad801f3b47f1ee0e0cf90ab78a20983">serialcom_status</a>(pSerialPortConfig);
<a name="l00257"></a>00257                 <span class="keywordflow">if</span>( (status &amp; <a class="code" href="serialcom_8h.html#a76de90ac046bfb9000ccd6845f71f25d">SERIALCOM_STATUSMASK_RX_DATA_READY</a>) ){
<a name="l00258"></a>00258 <span class="comment">//                      printf(&quot;\n FILE = %s, LINE = %i&quot;,__FILE__,__LINE__);</span>
<a name="l00259"></a>00259                         *pData = inb(pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#a60c95986733fae1a71ab89bd97ebfed4">ComPortAddress</a> + 0);
<a name="l00260"></a>00260 <span class="comment">//                      printf(&quot;\n Porta %i, Retornando estado %i&quot;, pSerialPortConfig-&gt;ComPortNumber, SERIALCOM_SUCCESS);</span>
<a name="l00261"></a>00261                         <span class="keywordflow">return</span>(<a class="code" href="serialcom_8h.html#a5a0fdec1e76957e187bd57ebb437fb99">SERIALCOM_SUCCESS</a>);
<a name="l00262"></a>00262                 }
<a name="l00263"></a>00263                 <span class="keywordflow">if</span>( (status &amp; <a class="code" href="serialcom_8h.html#ae5c00c56a89414cda5b5261d2cd4fdde">SERIALCOM_STATUSMASK_ERROR_RX_FIFO</a>) ){
<a name="l00264"></a>00264                         *pData = inb(pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#a60c95986733fae1a71ab89bd97ebfed4">ComPortAddress</a> + 0);
<a name="l00265"></a>00265                         <span class="keywordflow">return</span>(<a class="code" href="serialcom_8h.html#a1a67c2540b6be0d469eebef6e9e96dcc">SERIALCOM_ERROR_RX_FIFO</a>);
<a name="l00266"></a>00266                 }
<a name="l00267"></a>00267                 <span class="keywordflow">if</span>( (status &amp; <a class="code" href="serialcom_8h.html#af27289e4b3313a8c4e760873675af13d">SERIALCOM_STATUSMASK_BREAK_INTERRUPT</a>) ){
<a name="l00268"></a>00268                         *pData = inb(pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#a60c95986733fae1a71ab89bd97ebfed4">ComPortAddress</a> + 0);
<a name="l00269"></a>00269                         <span class="keywordflow">return</span>(<a class="code" href="serialcom_8h.html#ade5b6f987d2dadd0131c5d27f8cc5f8a">SERIALCOM_ERROR_BREAK_INTERRUPT</a>);
<a name="l00270"></a>00270                 }
<a name="l00271"></a>00271                 <span class="keywordflow">if</span>( (status &amp; <a class="code" href="serialcom_8h.html#a38247958e5a046a9a90d90527732b7da">SERIALCOM_STATUSMASK_FRAMING_ERROR</a>) ){
<a name="l00272"></a>00272                         *pData = inb(pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#a60c95986733fae1a71ab89bd97ebfed4">ComPortAddress</a> + 0);
<a name="l00273"></a>00273                         <span class="keywordflow">return</span>(<a class="code" href="serialcom_8h.html#a359da035668c376c888820dd42cb91c9">SERIALCOM_ERROR_FRAMING_ERROR</a>);
<a name="l00274"></a>00274                 }
<a name="l00275"></a>00275                 <span class="keywordflow">if</span>( (status &amp; <a class="code" href="serialcom_8h.html#ad7af17851b352bdb2765fc1a00e039d9">SERIALCOM_STATUSMASK_PARITY_ERROR</a>) ){
<a name="l00276"></a>00276                         *pData = inb(pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#a60c95986733fae1a71ab89bd97ebfed4">ComPortAddress</a> + 0);
<a name="l00277"></a>00277                         <span class="keywordflow">return</span>(<a class="code" href="serialcom_8h.html#a1ea5eb01e40f61443fe872822b18ced7">SERIALCOM_ERROR_PARITY_ERROR</a>);
<a name="l00278"></a>00278                 }
<a name="l00279"></a>00279                 <span class="keywordflow">if</span>( (status &amp; <a class="code" href="serialcom_8h.html#a29210113c4ba476836bbc3aa7213cc41">SERIALCOM_STATUSMASK_OVERRUN_ERROR</a>) ){
<a name="l00280"></a>00280                         *pData = inb(pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#a60c95986733fae1a71ab89bd97ebfed4">ComPortAddress</a> + 0);
<a name="l00281"></a>00281                         <span class="keywordflow">return</span>(<a class="code" href="serialcom_8h.html#a868b290a06e47ca2d5bb2dd7e80c62af">SERIALCOM_ERROR_OVERRUN_ERROR</a>);
<a name="l00282"></a>00282                 }
<a name="l00283"></a>00283                 
<a name="l00284"></a>00284                 <a class="code" href="serialcom-sb16c1052pci-xenomai_8c.html#ab8562a5ce361317b4d7453a8354a5685">serialcom_delayus</a>(0.2*pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#ae5c4edc520a9a85a82daada36fb4ea40">FramePeriodUS</a>);
<a name="l00285"></a>00285                 ElapsedTime += 0.2*pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#ae5c4edc520a9a85a82daada36fb4ea40">FramePeriodUS</a>;
<a name="l00286"></a>00286 <span class="comment">//              printf(&quot;\n ElapsedTime = %f&quot;,ElapsedTime);</span>
<a name="l00287"></a>00287                 <span class="keywordflow">if</span>(ElapsedTime &gt;= MaximaEsperaUS){
<a name="l00288"></a>00288 <span class="comment">//                      printf(&quot;\n FILE = %s, LINE = %i&quot;,__FILE__,__LINE__);</span>
<a name="l00289"></a>00289 <span class="comment">//                      printf(&quot;\n Porta %i, Retornando estado %i&quot;, pSerialPortConfig-&gt;ComPortNumber, SERIALCOM_ERROR_MAXWAITFORRECEPTION);</span>
<a name="l00290"></a>00290                         <span class="keywordflow">return</span>(<a class="code" href="serialcom_8h.html#a7f072f5d8e091db1bfe224b4548d6205">SERIALCOM_ERROR_MAXWAITFORRECEPTION</a>);  <span class="comment">// Dado nao chegou no tempo estipulado.</span>
<a name="l00291"></a>00291                 }
<a name="l00292"></a>00292         }
<a name="l00293"></a>00293 }
<a name="l00294"></a>00294 
<a name="l00311"></a><a class="code" href="serialcom_8h.html#a7ad801f3b47f1ee0e0cf90ab78a20983">00311</a> <span class="keywordtype">int</span> <a class="code" href="serialcom-sb16c1052pci-xenomai_8c.html#a7ad801f3b47f1ee0e0cf90ab78a20983">serialcom_status</a>(<a class="code" href="structSERIALPORTCONFIG.html">PSERIALPORTCONFIG</a> pSerialPortConfig)
<a name="l00312"></a>00312 {
<a name="l00313"></a>00313         <span class="keywordflow">return</span> inb(pSerialPortConfig-&gt;<a class="code" href="structSERIALPORTCONFIG.html#a60c95986733fae1a71ab89bd97ebfed4">ComPortAddress</a> + 5);
<a name="l00314"></a>00314 }
<a name="l00315"></a>00315 
<a name="l00316"></a>00316 <span class="comment">/************* Rotinas Genericas de Manipulacao da porta serial com acesso interno *****************/</span>
<a name="l00317"></a>00317 
<a name="l00326"></a><a class="code" href="serialcom-sb16c1052pci-xenomai_8c.html#ac47f39cfcf8738d1da7022b1f466fcab">00326</a> <span class="keywordtype">int</span> <a class="code" href="serialcom-sb16c1052pci-xenomai_8c.html#ac47f39cfcf8738d1da7022b1f466fcab">serialcom_pci_find_device</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> vendor_id, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> device_id, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *pbase_address, <span class="keyword">struct</span> pci_access **ppacc)
<a name="l00327"></a>00327 {
<a name="l00328"></a>00328         <span class="keyword">struct </span>pci_dev *dev;
<a name="l00329"></a>00329         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> c;
<a name="l00330"></a>00330         <span class="keywordtype">char</span> namebuf[1024], *name;
<a name="l00331"></a>00331 
<a name="l00332"></a>00332         <span class="comment">/* Get the pci_access structure */</span>
<a name="l00333"></a>00333         *ppacc = pci_alloc();
<a name="l00334"></a>00334         <span class="comment">/* Set all options you want -- here we stick with the defaults */</span>
<a name="l00335"></a>00335         <span class="comment">/* Initialize the PCI library */</span>
<a name="l00336"></a>00336         pci_init(*ppacc);               
<a name="l00337"></a>00337         <span class="comment">/* We want to get the list of devices */</span>
<a name="l00338"></a>00338         pci_scan_bus(*ppacc);           
<a name="l00339"></a>00339         <span class="comment">/* Iterate over all devices */</span>
<a name="l00340"></a>00340         <span class="keywordflow">for</span>(dev=(*ppacc)-&gt;devices; dev; dev=dev-&gt;next){
<a name="l00341"></a>00341                 <span class="comment">/* Fill in header info we need */</span>
<a name="l00342"></a>00342                 pci_fill_info(dev, PCI_FILL_IDENT | PCI_FILL_BASES | PCI_FILL_CLASS | PCI_FILL_IRQ);    
<a name="l00343"></a>00343                 <span class="comment">/* Read config register directly */</span>
<a name="l00344"></a>00344                 c = pci_read_byte(dev, PCI_INTERRUPT_PIN);                              
<a name="l00345"></a>00345                 printf(<span class="stringliteral">&quot;\n    %04x:%02x:%02x.%d vendor=%04x device=%04x class=%04x irq=%d (pin %d) base0=%lx&quot;</span>,
<a name="l00346"></a>00346                         dev-&gt;domain, dev-&gt;bus, dev-&gt;dev, dev-&gt;func, dev-&gt;vendor_id, dev-&gt;device_id,
<a name="l00347"></a>00347                         dev-&gt;device_class, dev-&gt;irq, c, (<span class="keywordtype">long</span>) dev-&gt;base_addr[0]);
<a name="l00348"></a>00348                 <span class="comment">/* Look up and print the full name of the device */</span>
<a name="l00349"></a>00349                 name = pci_lookup_name(*ppacc, namebuf, <span class="keyword">sizeof</span>(namebuf), PCI_LOOKUP_DEVICE, dev-&gt;vendor_id, dev-&gt;device_id);
<a name="l00350"></a>00350                 printf(<span class="stringliteral">&quot; (%s)&quot;</span>, name);
<a name="l00351"></a>00351                 <span class="comment">/* Connect */</span>
<a name="l00352"></a>00352                 <span class="keywordflow">if</span>((dev-&gt;vendor_id==vendor_id)&amp;&amp;(dev-&gt;device_id==device_id)){
<a name="l00353"></a>00353                         <span class="comment">// recover base address</span>
<a name="l00354"></a>00354                         *pbase_address = pci_read_long(dev, PCI_BASE_ADDRESS_0);
<a name="l00355"></a>00355                         *pbase_address &amp;= PCI_BASE_ADDRESS_IO_MASK;
<a name="l00356"></a>00356 
<a name="l00357"></a>00357                         <span class="keywordflow">return</span> 1;
<a name="l00358"></a>00358                 }
<a name="l00359"></a>00359         }
<a name="l00360"></a>00360         <span class="comment">/* Close everything */</span>
<a name="l00361"></a>00361         pci_cleanup(*ppacc);            
<a name="l00362"></a>00362         
<a name="l00363"></a>00363         <span class="keywordflow">return</span> 0;
<a name="l00364"></a>00364 }
<a name="l00365"></a>00365 
<a name="l00366"></a><a class="code" href="serialcom-sb16c1052pci-xenomai_8c.html#ad43e67f6cf73e5f0ca1a1490f4e68d6f">00366</a> <span class="keywordtype">void</span> <a class="code" href="serialcom-sb16c1052pci-xenomai_8c.html#ad43e67f6cf73e5f0ca1a1490f4e68d6f">serialcom_pci_close_device</a>(<span class="keyword">struct</span> pci_access *pacc)
<a name="l00367"></a>00367 {
<a name="l00368"></a>00368         <span class="comment">/* Close everything */</span>
<a name="l00369"></a>00369         pci_cleanup(pacc);              
<a name="l00370"></a>00370 }
<a name="l00371"></a>00371 
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Fri Jan 14 10:33:49 2011 for mmrobot-server by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
